<?xml version="1.0"?>
<project name="Lucene With Geo-Temporal Extensions" default="compile" basedir=".">

    <description>Lucene With Geo-Temporal Extensions</description>

    <property file="deployer.properties" />

    <!-- Configure the directory into which the web application is built -->
    <property name="build" value="${base.dir}/build" />

    <property name="webapp.path" value="${build}/webapp${path}" />

    <path id="deployer.classpath">
        <fileset dir="${base.dir}/lib">
            <include name="*.jar" />
        </fileset>
    </path>

    <!-- Configure the custom Ant tasks for the Manager application -->
    <taskdef resource="org/apache/catalina/ant/catalina.tasks" classpathref="deployer.classpath" />
    <taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="deployer.classpath" />

    <!-- Executable Targets -->
    <target name="clean" description="Removes build directory">
        <delete dir="${build}" />
    </target>

    <target name="compileClasses">
        <copy todir="${webapp.path}">
            <fileset dir="${webapp}">
                <exclude name="${base.dir}/lib/servlet-api.jar" />
                <exclude name="${base.dir}/lib/jsp-api.jar" />
            </fileset>
        </copy>
        <replace file="${webapp.path}/WEB-INF/classes/pt/utl/ist/lucene/app.properties" value="">
            <replacefilter token="@tmp.dir@" value="${base.dir}/test-index" />
            <replacefilter token="@index.dir@" value="${base.dir}/test-index" />
            <replacefilter token="@data.dir@" value="${base.dir}/test-data" />
        </replace>
        <jasper2 validateXml="false" uriroot="${webapp.path}" webXmlFragment="${webapp.path}/WEB-INF/generated_web.xml" addWebXmlMappings="true" outputDir="${webapp.path}/WEB-INF/classes" />
        <mkdir dir="${webapp.path}/WEB-INF/lib" />
        <mkdir dir="${webapp.path}/WEB-INF/classes" />
        <javac destdir="${webapp.path}/WEB-INF/classes" optimize="off" debug="true" debuglevel="lines,vars,source" nowarn="true" deprecation="${compile.deprecation}" failonerror="false" srcdir="${webapp.path}/WEB-INF/classes" encoding="UTF-8" excludes="**/*.smap">
            <classpath>
                <fileset dir="${webapp.path}/WEB-INF/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
                <fileset dir="${base.dir}/lib">
                    <include name="*.jar" />
                </fileset>
            </classpath>
            <include name="**" />
            <exclude name="tags/**" />
        </javac>
        <delete file="${webapp.path}/WEB-INF/lib/servlet-api.jar" />
        <delete file="${webapp.path}/WEB-INF/lib/jsp-api.jar" />
    </target>

    <target name="compile" description="Compile web application" depends="clean">
        <antcall target="compileClasses"/>
        <jar destfile="${webapp.path}.war" basedir="${webapp.path}" />
    </target>

    <target name="deploy" depends="compile" description="Deploy web application">
        <deploy url="${url}" username="${username}" password="${password}" path="${path}" war="${webapp.path}.war" update="true" />
    </target>

    <target name="undeploy" description="Undeploy web application">
        <undeploy url="${url}" username="${username}" password="${password}" path="${path}" />
    </target>

    <target name="all" description="Build and deploy">
        <antcall target="compile">
        </antcall>
        <antcall target="deploy">
        </antcall>
    </target>

    <!-- Webapp lifecycle control -->
    <target name="start" description="Start web application">
        <start url="${url}" username="${username}" password="${password}" path="${path}" />
    </target>
    <target name="reload" description="Reload web application">
        <reload url="${url}" username="${username}" password="${password}" path="${path}" />
    </target>
    <target name="stop" description="Stop web application">
        <stop url="${url}" username="${username}" password="${password}" path="${path}" />
    </target>

    <target name="javadoc">
        <javadoc destdir="${webapp.path}/WEB-INF/javadoc">
            <sourcepath path="${webapp.path}/WEB-INF/classes" />
            <classpath>
                <fileset dir="${webapp.path}/WEB-INF/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
                <fileset dir="${base.dir}/lib">
                    <include name="*.jar" />
                </fileset>
            </classpath>
        </javadoc>
    </target>

    <target name="test" depends="" description="Unit Tests and Examples">
        <junit showoutput="true" haltonerror="true" printsummary="true">
            <classpath path="${webapp.path}/WEB-INF/classes">
                <fileset dir="${webapp.path}/WEB-INF/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
                <fileset dir="${base.dir}/lib">
                    <include name="*.jar" />
                </fileset>
            </classpath>

            <test name="pt.utl.ist.lucene.test.highlights.TestHighlightsWithSIMPLE" />

            <test name="pt.utl.ist.lucene.test.TestTimeDistanceWithLgteSIMPLE"/>
            <test name="pt.utl.ist.lucene.test.TestSpatialDistanceWithLgteSIMPLE" />
            <test name="pt.utl.ist.lucene.test.TestTimeDistanceWithLgte" />
            <test name="pt.utl.ist.lucene.test.TestSpatialDistanceWithLgteQueryString" />
            <test name="pt.utl.ist.lucene.test.TestSpatialDistanceWithLgteQueryParser" />
            <test name="pt.utl.ist.lucene.test.TestSpatialDistanceWithLgte" />

            <test name="pt.utl.ist.lucene.test.advancedtests.TestSpatialBoxIndexingWithLgte" />
            <test name="pt.utl.ist.lucene.test.advancedtests.TestSpatialBoxQueringWithLgte" />
            <test name="pt.utl.ist.lucene.test.advancedtests.TestSpatialDistanceFiltering" />
            <test name="pt.utl.ist.lucene.test.advancedtests.TestTimeBoxIndexingWithLgte" />
            <test name="pt.utl.ist.lucene.test.advancedtests.TestTimeBoxQueringWithLgte" />
            <test name="pt.utl.ist.lucene.test.advancedtests.TestTimeDistanceFiltering" />
            <test name="pt.utl.ist.lucene.test.advancedtests.TestTimeDistanceInMilisecondsWithLgte" />
            <test name="pt.utl.ist.lucene.test.advancedtests.TestTimeIntervalsInMilisecondsWithLgte" />

            <test name="pt.utl.ist.lucene.test.modelsorter.TestTimeDistanceWithLgteModelOrderScore" />
            <test name="pt.utl.ist.lucene.test.modelsorter.TestTimeDistanceWithLgteModelOrder" />
            <test name="pt.utl.ist.lucene.test.modelsorter.TestTimeDistanceWithLgteModel" />
            <test name="pt.utl.ist.lucene.test.modelsorter.TestSpatialDistanceWithLgteModelOrderScore" />
            <test name="pt.utl.ist.lucene.test.modelsorter.TestSpatialDistanceWithLgteModelFiltering" />
            <test name="pt.utl.ist.lucene.test.modelsorter.TestSpatialDistanceWithLgteModel" />

            <test name="pt.utl.ist.lucene.test.modelsorter.scoretimespace.TestTimeSpatialTextDistanceTogetherSpatialAndTimeScore" />
            <test name="pt.utl.ist.lucene.test.modelsorter.scoretimespace.TestTimeSpatialTextDistanceTogetherChangingConfiguration" />
            <test name="pt.utl.ist.lucene.test.modelsorter.scoretimespace.TestTimeSpatialTextDistanceTogetherButOnlySpatialActive" />

            <test name="pt.utl.ist.lucene.test.objectwidth.TestWidthSigmoidLgteSIMPLE" />

            <test name="pt.utl.ist.lucene.test.qe.TestQueryExpansionWithLgteInsideExpansionSIMPLE" />
            <test name="pt.utl.ist.lucene.test.qe.TestQueryExpansionWithLgteSIMPLE" />

            <test name="pt.utl.ist.lucene.test.queryconfiguration.TestQueryExpansionConfigurationWithLgteSIMPLE" />
        </junit>
    </target>

    <target name="build-test-index-brauncorpus" depends="" description="Index a Collection and run all the topics">
        <mkdir dir="${webapp.path}/WEB-INF/brauncorpus/test-data/output"/>
        <java fork="true" classname="pt.utl.ist.lucene.treceval.BrounCorpusExample">
            <classpath>
                <fileset dir="${webapp.path}/WEB-INF/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
            </classpath>
            <classpath path="${webapp.path}/WEB-INF/classes" />
            <arg value="${webapp.path}/WEB-INF/test-index" />
            <arg value="${webapp.path}/WEB-INF/test-data" />
        </java>
        <antcall target="copyIndexesToDataDirs"/>
    </target>

     <target name="build-test-index-cran" depends="" description="Index a Collection and run all the topics">
        <mkdir dir="${webapp.path}/WEB-INF/cran/test-data/output"/>
        <java fork="true" classname="pt.utl.ist.lucene.treceval.CranfieldExample">
            <classpath>
                <fileset dir="${webapp.path}/WEB-INF/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
            </classpath>
            <classpath path="${webapp.path}/WEB-INF/classes" />
            <arg value="${webapp.path}/WEB-INF/test-index" />
            <arg value="${webapp.path}/WEB-INF/test-data" />
        </java>
        <antcall target="copyIndexesToDataDirs"/>
    </target>

    <target name="build-test-index-dmoz" depends="" description="Index a Collection and run all the topics">
        <mkdir dir="${webapp.path}/WEB-INF/dmoz/test-data/output"/>
        <java fork="true" classname="pt.utl.ist.lucene.treceval.DmozExample" jvmargs="-server">
            <classpath>
                <fileset dir="${webapp.path}/WEB-INF/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
            </classpath>
            <classpath path="${webapp.path}/WEB-INF/classes" />
            <arg value="${webapp.path}/WEB-INF/test-index" />
            <arg value="${webapp.path}/WEB-INF/test-data" />
        </java>
        <antcall target="copyIndexesToDataDirs"/>
    </target>

    <target name="build-test-index-digmap" depends="" description="Index a Collection and run all the topics">
        <mkdir dir="${webapp.path}/WEB-INF/test-data/digmap/output"/>
        <java fork="true" classname="pt.utl.ist.lucene.treceval.DigmapExample">

            <classpath>
                <fileset dir="${webapp.path}/WEB-INF/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
            </classpath>
            <classpath path="${webapp.path}/WEB-INF/classes" />
            <arg value="${webapp.path}/WEB-INF/test-index" />
            <arg value="${webapp.path}/WEB-INF/test-data" />
        </java>
        <antcall target="copyIndexesToDataDirs"/>
    </target>

    <target name="build-test-index-brauncorpus-evaluate" depends="compile" description="Index a Collection and run all the topics">
        <antcall target="build-test-index-brauncorpus"/>
        <antcall target="evaluation-metrics-brauncorpus" />
        <antcall target="significance-tests-brauncorpus" />
    </target>

    <target name="build-test-index-cran-evaluate" depends="compile" description="Index a Collection and run all the topics">
        <antcall target="build-test-index-cran"/>
        <antcall target="evaluation-metrics-cran" />
        <antcall target="significance-tests-cran" />
    </target>
    

    <target name="build-test-index-dmoz-evaluate" depends="compile" description="Index a Collection and run all the topics">
        <antcall target="build-test-index-dmoz"/>
        <antcall target="evaluation-metrics-dmoz" />
        <antcall target="significance-tests-dmoz" />
    </target>

    <target name="evaluation-metrics-brauncorpus" description="Generate trec_eval results">
        <for param="runfile">
            <path>
                <fileset dir="${webapp.path}/WEB-INF/test-data/brauncorpus/output/">
                    <include name="*.txt" />
                    <exclude name="*-treceval-report.txt" />
                    <exclude name="*-significance-report.txt" />
                </fileset>
            </path>
            <sequential>
                <java fork="true" classname="ireval.Main" output="@{runfile}-treceval-report.txt">
                    <classpath>
                        <fileset dir="${webapp.path}/WEB-INF/lib">
                            <include name="*.jar" />
                        </fileset>
                        <fileset dir="${base.dir}/lib">
                            <include name="*.jar" />
                        </fileset>
                    </classpath>
                    <classpath path="${webapp.path}/WEB-INF/classes" />
                    <arg value="@{runfile}" />
                    <arg value="${webapp.path}/WEB-INF/test-data/brauncorpus/assessements/qrels.ac-gls.txt" />
                </java>
            </sequential>
        </for>
    </target>

    <target name="evaluation-metrics-cran" description="Generate trec_eval results">
        <for param="runfile">
            <path>
                <fileset dir="${webapp.path}/WEB-INF/test-data/cran/output/">
                    <include name="*.txt" />
                    <exclude name="*-treceval-report.txt" />
                    <exclude name="*-significance-report.txt" />
                </fileset>
            </path>
            <sequential>
                <java fork="true" classname="ireval.Main" output="@{runfile}-treceval-report.txt">
                    <classpath>
                        <fileset dir="${webapp.path}/WEB-INF/lib">
                            <include name="*.jar" />
                        </fileset>
                        <fileset dir="${base.dir}/lib">
                            <include name="*.jar" />
                        </fileset>
                    </classpath>
                    <classpath path="${webapp.path}/WEB-INF/classes" />
                    <arg value="@{runfile}" />
                    <arg value="${webapp.path}/WEB-INF/test-data/cran/assessements/cran.qrels" />
                </java>
            </sequential>
        </for>
    </target>

     <target name="evaluation-metrics-dmoz" description="Generate trec_eval results">
        <for param="runfile">
            <path>
                <fileset dir="${webapp.path}/WEB-INF/test-data/dmoz/output/">
                    <include name="*.txt" />
                    <exclude name="*-treceval-report.txt" />
                    <exclude name="*-significance-report.txt" />
                </fileset>
            </path>
            <sequential>
                <java fork="true" classname="ireval.Main" output="@{runfile}-treceval-report.txt">
                    <classpath>
                        <fileset dir="${webapp.path}/WEB-INF/lib">
                            <include name="*.jar" />
                        </fileset>
                        <fileset dir="${base.dir}/lib">
                            <include name="*.jar" />
                        </fileset>
                    </classpath>
                    <classpath path="${webapp.path}/WEB-INF/classes" />
                    <arg value="@{runfile}" />
                    <arg value="${webapp.path}/WEB-INF/test-data/dmoz/assessements/qrels" />
                </java>
            </sequential>
        </for>
    </target>

    <target name="significance-tests-brauncorpus" description="Generate trec_eval results">
        <for param="runfile">
            <path>
                <fileset dir="${webapp.path}/WEB-INF/test-data/brauncorpus/output/">
                    <include name="*.txt" />
                    <exclude name="*-treceval-report.txt" />
                    <exclude name="*-significance-report.txt" />
                </fileset>
            </path>
            <sequential>
                <for param="runfile2">
                    <path>
                        <fileset dir="${webapp.path}/WEB-INF/test-data/brauncorpus/output/">
                            <include name="*.txt" />
                            <exclude name="*-treceval-report.txt" />
                            <exclude name="*-significance-report.txt" />
                            <exclude name="@{runfile}" />
                        </fileset>
                    </path>
                    <sequential>
                        <java fork="true" classname="ireval.Main">
                            <classpath>
                                <fileset dir="${webapp.path}/WEB-INF/lib">
                                    <include name="**.jar" />
                                </fileset>
                                <fileset dir="${base.dir}/lib">
                                    <include name="*.jar" />
                                </fileset>
                            </classpath>
                            <classpath path="${webapp.path}/WEB-INF/classes" />
                            <arg value="@{runfile}" />
                            <arg value="@{runfile2}" />
                            <arg value="${webapp.path}/WEB-INF/test-data/brauncorpus/assessements/qrels.ac-gls.txt" />
                        </java>
                    </sequential>
                </for>
            </sequential>
        </for>
    </target>

    <target name="significance-tests-cran" description="Generate trec_eval results">
        <for param="runfile">
            <path>
                <fileset dir="${webapp.path}/WEB-INF/test-data/cran/output/">
                    <include name="*.txt" />
                    <exclude name="*-treceval-report.txt" />
                    <exclude name="*-significance-report.txt" />
                </fileset>
            </path>
            <sequential>
                <for param="runfile2">
                    <path>
                        <fileset dir="${webapp.path}/WEB-INF/test-data/cran/output/">
                            <include name="*.txt" />
                            <exclude name="*-treceval-report.txt" />
                            <exclude name="*-significance-report.txt" />
                            <exclude name="@{runfile}" />
                        </fileset>
                    </path>
                    <sequential>
                        <java fork="true" classname="ireval.Main">
                            <classpath>
                                <fileset dir="${webapp.path}/WEB-INF/lib">
                                    <include name="**.jar" />
                                </fileset>
                                <fileset dir="${base.dir}/lib">
                                    <include name="*.jar" />
                                </fileset>
                            </classpath>
                            <classpath path="${webapp.path}/WEB-INF/classes" />
                            <arg value="@{runfile}" />
                            <arg value="@{runfile2}" />
                            <arg value="${webapp.path}/WEB-INF/test-data/cran/assessements/cran.qrels" />
                        </java>
                    </sequential>
                </for>
            </sequential>
        </for>
    </target>

    <target name="significance-tests-dmoz" description="Generate trec_eval results">
        <for param="runfile">
            <path>
                <fileset dir="${webapp.path}/WEB-INF/test-data/dmoz/output/">
                    <include name="*.txt" />
                    <exclude name="*-treceval-report.txt" />
                    <exclude name="*-significance-report.txt" />
                </fileset>
            </path>
            <sequential>
                <for param="runfile2">
                    <path>
                        <fileset dir="${webapp.path}/WEB-INF/test-data/dmoz/output/">
                            <include name="*.txt" />
                            <exclude name="*-treceval-report.txt" />
                            <exclude name="*-significance-report.txt" />
                            <exclude name="@{runfile}" />
                        </fileset>
                    </path>
                    <sequential>
                        <java fork="true" classname="ireval.Main">
                            <classpath>
                                <fileset dir="${webapp.path}/WEB-INF/lib">
                                    <include name="**.jar" />
                                </fileset>
                                <fileset dir="${base.dir}/lib">
                                    <include name="*.jar" />
                                </fileset>
                            </classpath>
                            <classpath path="${webapp.path}/WEB-INF/classes" />
                            <arg value="@{runfile}" />
                            <arg value="@{runfile2}" />
                            <arg value="${webapp.path}/WEB-INF/test-data/dmoz/assessements/qrels" />
                        </java>
                    </sequential>
                </for>
            </sequential>
        </for>
    </target>

    <target name="copyIndexesToDataDirs">
        <delete>
            <fileset dir="./test-index">
                <include name="**/*"/>
                <exclude name="**/*.svn"/>
            </fileset>
        </delete>
        <copy todir="./test-index" overwrite="true">
            <fileset dir="${webapp.path}/WEB-INF/test-index">
                <include name="**/*"/>
            </fileset>
        </copy>
    </target>

</project>