<?xml version="1.0"?>
<project name="Lucene With Geo-Temporal Extensions" default="jarTest" basedir=".">

    <description>Lucene With Geo-Temporal Extensions</description>

    <import file="libs.xml"/>
    <import file="tests.xml"/>


    <target name="jarTest" depends="clean,jar,testXml">
        <echo message="Please CHECK WEB-INF/build/test/report"/>
        <echo message="Please CHECK jar file at lgte root folder"/>
    </target>


    <target name="jar" depends="compile">

        <replace file="${webapp.path}/WEB-INF/classes/pt/utl/ist/lucene/app.properties" value="">
            <replacefilter token="cache.use.docid.cache=true" value="cache.use.docid.cache=false" />
        </replace>
        <replace file="${webapp.path}/WEB-INF/classes/log4j.properties" value="">
            <replacefilter token="log4j.rootLogger = info" value="log4j.rootLogger = error" />
            <replacefilter token="log4j.rootLogger=info" value="log4j.rootLogger=error" />
        </replace>
        <jar destfile="${jar.file}" basedir="${webapp.path}/WEB-INF/classes/">
            <manifest>
                <attribute name="Built-By" value="${user.name}" />
                <!--<attribute name="Main-Class" value="my.path.to.the.main.Application" />-->
                <section name="lgte">
                    <attribute name="Specification-Title" value="LGTE - Lucene GeoTemporal Extensions" />
                    <attribute name="Specification-Version" value="${version.number}" />
                    <attribute name="Specification-Vendor" value="Jorge Machado" />
                    <attribute name="Implementation-Version" value="${version.number}" />
                    <attribute name="Implementation-Vendor" value="Jorge Machado" />
                </section>

                <!-- finally, use the magically generated libs path -->
                <!--<attribute name="Class-Path" value="${libs.project}" />-->
            </manifest>
        </jar>
        <copy file="${jar.file}" todir="${webapp}"/>
    </target>

    <target name="initDirs">
        <mkdir dir="${webapp.path}/WEB-INF/lib/"/>
        <mkdir dir="${webapp.path}/WEB-INF/classes/"/>
        <mkdir dir="${dist.path}"/>
        <mkdir dir="${test.report}"/>
        <mkdir dir="${test.data}"/>
    </target>

    <target name="clean" description="Removes build directory">
        <delete dir="${build}" />
    </target>

    <target name="configuration">
        <replace file="${webapp.path}/WEB-INF/classes/pt/utl/ist/lucene/app.properties" value="">
            <replacefilter token="@tmp.dir@" value="${base.dir}/test-index" />
            <replacefilter token="@index.dir@" value="${base.dir}/test-index" />
            <replacefilter token="@data.dir@" value="${base.dir}/test-data" />
        </replace>
    </target>

    <target name="compile" depends="initDirs">
        <copy todir="${webapp.path}/WEB-INF/classes">
            <fileset dir="${base.dir}/classes">
                <include name="**/*.*"/>
            </fileset>
        </copy>
        <copy todir="${webapp.path}/WEB-INF/classes" overwrite="true">
            <fileset dir="${base.dir}/classes">
                <include name="**/*.properties"/>
                <include name="**/*.xml"/>
            </fileset>
        </copy>
        <antcall target="configuration"/>
        <javac destdir="${webapp.path}/WEB-INF/classes" optimize="off" debug="true" debuglevel="lines,vars,source" nowarn="true" deprecation="${compile.deprecation}" failonerror="true" srcdir="${webapp.path}/WEB-INF/classes" encoding="UTF-8" excludes="**/*.smap">
            <classpath>
                <fileset dir="${base.dir}/lib">
                    <include name="*.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
            </classpath>
            <include name="**" />
            <exclude name="tags/**" />
        </javac>
    </target>

    <target name="prepareWarWithTestData">
        <mkdir dir="${webapp.path}/WEB-INF"/>
        <mkdir dir="${webapp.path}/WEB-INF/test-data"/>
        <mkdir dir="${webapp.path}/WEB-INF/test-index"/>
        <antcall target="prepareWar"/>
        <copy todir="${webapp.path}/WEB-INF/test-data">
            <fileset dir="${base.dir}/test-data">
                <include name="**/*" />
            </fileset>
        </copy>
        <copy todir="${webapp.path}/WEB-INF/test-index">
            <fileset dir="${base.dir}/test-index">
                <include name="**/*" />
            </fileset>
        </copy>
    </target>

    <target name="prepareWar" depends="compile">
        <mkdir dir="${webapp.path}/WEB-INF"/>

        <mkdir dir="${webapp.path}/WEB-INF/classes"/>
        <mkdir dir="${webapp.path}/WEB-INF/lib"/>
        <copy todir="${webapp.path}/WEB-INF/classes">
            <fileset dir="${base.dir}/classes">
                <include name="**/*" />
            </fileset>
        </copy>
        <copy todir="${webapp.path}/WEB-INF/lib">
            <fileset dir="${base.dir}/lib">
                <include name="*.jar" />
                <exclude name="${base.dir}/lib/servlet-api.jar" />
                <exclude name="${base.dir}/lib/jsp-api.jar" />
                <exclude name="${base.dir}/lib/jasper*" />
            </fileset>
        </copy>
        <copy todir="${webapp.path}/WEB-INF">
            <fileset dir="${base.dir}">
                <include name="*.xml" />
            </fileset>
        </copy>
        <copy todir="${webapp.path}">
            <fileset dir="${webapp}">
                <include name="*.jsp" />
            </fileset>
        </copy>


        <!--<jasper2 validateXml="false" uriroot="${webapp.path}" webXmlFragment="${webapp.path}/WEB-INF/generated_web.xml" addWebXmlMappings="true" outputDir="${webapp.path}/WEB-INF/classes" />-->

        <javac destdir="${webapp.path}/WEB-INF/classes" optimize="off" debug="true" debuglevel="lines,vars,source" nowarn="true" deprecation="${compile.deprecation}" failonerror="false" srcdir="${webapp.path}/WEB-INF/classes" encoding="UTF-8" excludes="**/*.smap">
            <classpath>
                <fileset dir="${base.dir}/lib">
                    <include name="**.jar" />
                    <exclude name="servlet-api.jar" />
                    <exclude name="jsp-api.jar" />
                </fileset>
                <fileset dir="${base.dir}/lib">
                    <include name="*.jar" />
                </fileset>
            </classpath>
            <include name="**" />
            <exclude name="tags/**" />
        </javac>
        <delete file="${webapp.path}/WEB-INF/lib/servlet-api.jar" />
        <delete file="${webapp.path}/WEB-INF/lib/jsp-api.jar" />
        <delete file="${webapp.path}/WEB-INF/lib/jasper-runtime.jar" />
        <delete file="${webapp.path}/WEB-INF/lib/jasper-compiler.jar" />
    </target>

    <target name="war" description="Compile web application">
        <antcall target="prepareWar"/>
        <jar destfile="${webapp.path}.war" basedir="${webapp.path}" />
    </target>



</project>